<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Interaction</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

    <h1>Voice Interaction with AI</h1>
    <button id="startRecording">Start Recording</button>
    <button id="stopRecording" disabled>Stop Recording</button>


    <div id="chatBox"></div>

    <div id="textInputSection">
        <input type="text" id="textMessage" placeholder="Type a message..." />
        <button id="sendMessage">Send</button>
    </div>


    <script>
        let mediaRecorder;
        let audioChunks = [];
        let stream;
    
        $('#startRecording').on('click', function () {
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(function (userStream) {
                    stream = userStream;
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
    
                    mediaRecorder.ondataavailable = function (event) {
                        audioChunks.push(event.data);
                    };
    
                    mediaRecorder.onstop = function () {
                        let audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        let formData = new FormData();
                        formData.append('audio', audioBlob, 'audio.wav');
                        const placeholder = $('<div>')
                            .addClass('user-message')
                            .text('ðŸŽ¤ Listening...');
                        $('#chatBox').append(placeholder);
                        $('#chatBox').scrollTop($('#chatBox')[0].scrollHeight);
                        
                        $.ajax({
                            url: '/transcribe/',  // Adjust this route if needed
                            type: 'POST',
                            data: formData,
                            contentType: false,
                            processData: false,
                            success: function (transcribeResponse) {
                                const userInput = transcribeResponse.user_input;
                                placeholder.text(userInput); // Update with actual user text

                                // Second request: send transcribed text to model
                                $.ajax({
                                    url: '/predict/',
                                    type: 'POST',
                                    data: JSON.stringify({ prompt: userInput }),
                                    contentType: 'application/json',
                                    success: function (predictResponse) {
                                        appendMessage(predictResponse.prediction, 'bot');

                                        if (predictResponse.audio_url) {
                                            let audio = new Audio(predictResponse.audio_url);
                                            audio.play();
                                        }
                                    },
                                    error: function (err) {
                                        console.log('Error from prediction:', err);
                                    }
                                });
                            },
                            error: function (error) {
                                console.log('Error during transcription:', error);
                            }
                        });

                        const audioUrl = URL.createObjectURL(audioBlob);
                        $('#responseAudio').attr('src', audioUrl);
                    };
    
                    mediaRecorder.start();
                    $('#startRecording').prop('disabled', true);
                    $('#stopRecording').prop('disabled', false);
                    console.log("ðŸŽ™ Recording started...");
                })
                .catch(function (error) {
                    console.log('Error accessing microphone:', error);
                });
        });
    
        $('#stopRecording').on('click', function () {
            if (mediaRecorder && mediaRecorder.state === "recording") {
                mediaRecorder.stop();
                stream.getTracks().forEach(track => track.stop());
                $('#startRecording').prop('disabled', false);
                $('#stopRecording').prop('disabled', true);
                console.log("âœ… Recording stopped.");
            }
        });
    
        function appendMessage(message, sender) {
            const chatBox = $('#chatBox');
            const messageElement = $('<div>')
                .addClass(sender === 'user' ? 'user-message' : 'bot-message')
                .text(message);
            chatBox.append(messageElement);
            chatBox.scrollTop(chatBox[0].scrollHeight);
        }
    
        $('#sendMessage').on('click', function () {
            const userMessage = $('#textMessage').val().trim();
            if (!userMessage) return;
    
            appendMessage(userMessage, 'user');
            $('#textMessage').val('');
    
            $.ajax({
                url: '/predict/',
                type: 'POST',
                data: JSON.stringify({ prompt: userMessage }),
                contentType: 'application/json',
                success: function (response) {
                    appendMessage(response.prediction, 'bot');
                },
                error: function (error) {
                    console.log('Error:', error);
                }
            });
        });
    </script>
    


</body>
</html>
